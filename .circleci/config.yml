version: 2
jobs:
  build:
    working_directory: ~/rian
    docker:
        - image: ceruberu/rian-primary:0.0.1
    steps:
        - checkout
        - run:
            name: Pre-Dependencies
            command: mkdir ~/rian/artifacts
        - restore_cache:
            keys: 
              - rian-{{ .Branch }}-{{ checksum "yarn.lock" }}
              - rian-{{ .Branch }}
              - rian-master
        - run:
            name: Install Dependencies
            command: yarn install
        - run:
            name: Test
            command: |
              node -v
              yarn run test:ci
        - save_cache:
            key: rian-{{ .Branch }}-{{ checksum "yarn.lock" }}
            paths:
              - "~/.cache/yarn"
        - store_artifacts:
            path: ~/rian/artifacts
            destination: prefix
        - store_test_results:
            path: ~/rian/test-results
        - deploy:
            command: |
                aws --version
                aws configure set default.s3.signature_version s3v4
                aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
                aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY 
                aws configure set default.region ap-northeast-2
                aws configure set default.output json
                aws s3 sync ~/rian s3://rian-s3-dev/ --delete --exclude 'node_modules/*' --exclude 'build/*'